name: Release docs

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: false
  push:
    tags:
      - '*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          curl -L $(curl -sL https://api.github.com/repos/typst/typst/releases/latest | grep -o "http.*x86_64.*linux.*\.tar\.xz") | tar xJ --strip-components=1
          sudo install typst /usr/local/bin/
          sudo apt-get update
          sudo apt-get install -y --install-suggests fonts-linuxlibertine fonts-noto fonts-ibm-plex fonts-cascadia-code

      - name: Build docs with make
        run: make

      - name: Determine release tag
        id: determine_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.tag }}" ]; then
              echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            else
              echo "tag=manual-${GITHUB_RUN_ID}" >> $GITHUB_OUTPUT
            fi
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.determine_tag.outputs.tag }}
          name: ${{ steps.determine_tag.outputs.tag }}
          files: |
            *.pdf
            *.pdfpc
          draft: true
